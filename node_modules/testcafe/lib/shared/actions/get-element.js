"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../adapter");
const is_window_iframe_1 = __importDefault(require("./utils/is-window-iframe"));
// @ts-ignore
const hammerhead_1 = require("../../client/driver/deps/hammerhead");
// @ts-ignore
const domUtils = __importStar(require("../../client/core/utils/dom"));
function ensureImageMap(imgElement, areaElement) {
    return hammerhead_1.Promise.resolve(domUtils.closest(areaElement, 'map'))
        .then((mapElement) => {
        return mapElement && mapElement.name === domUtils.getImgMapName(imgElement) ? areaElement : imgElement;
    });
}
function findElementOrNonEmptyChildFromPoint(point, element) {
    return hammerhead_1.Promise.resolve(adapter_1.adapter.position.getElementFromPoint(point))
        .then((topElement) => {
        return hammerhead_1.Promise.resolve(domUtils.containsElement(element, topElement))
            .then((containsEl) => containsEl && domUtils.getNodeText(topElement))
            .then((isNonEmptyChild) => isNonEmptyChild || topElement && domUtils.isNodeEqual(topElement, element) ? topElement : null);
    });
}
function correctTopElementByExpectedElement(topElement, expectedElement) {
    if (!expectedElement || !topElement || domUtils.isNodeEqual(topElement, expectedElement))
        return topElement;
    const isTREFElement = domUtils.getTagName(expectedElement) === 'tref';
    // NOTE: 'document.elementFromPoint' can't find these types of elements
    if (isTREFElement)
        return expectedElement;
    // NOTE: T299665 - Incorrect click automation for images with an associated map element in Firefox
    // All browsers return the <area> element from document.getElementFromPoint, but
    // Firefox returns the <img> element. We should accomplish this for Firefox as well.
    const isImageMapArea = domUtils.getTagName(expectedElement) === 'area' && domUtils.isImgElement(topElement);
    if (hammerhead_1.utils.browser.isFirefox && isImageMapArea)
        return ensureImageMap(topElement, expectedElement);
    // NOTE: try to find a multi-line link by its rectangle (T163678)
    return hammerhead_1.Promise.resolve(domUtils.closest(expectedElement, 'a'))
        .then((anchor) => !!anchor)
        .then((isLinkOrChildExpected) => {
        if (!isLinkOrChildExpected)
            return false;
        return hammerhead_1.Promise.resolve(domUtils.containsElement(expectedElement, topElement))
            .then((containsElement) => containsElement && domUtils.getNodeText(topElement))
            .then((isTopElementChildOfLink) => !isTopElementChildOfLink && domUtils.getNodeText(expectedElement));
    })
        .then((shouldSearchForMultilineLink) => {
        if (!shouldSearchForMultilineLink)
            return topElement;
        return hammerhead_1.Promise.resolve(adapter_1.adapter.position.getClientDimensions(expectedElement))
            .then((linkRect) => findElementOrNonEmptyChildFromPoint({ x: linkRect.right - 1, y: linkRect.top + 1 }, expectedElement)
            .then((el) => el || findElementOrNonEmptyChildFromPoint({ x: linkRect.left + 1, y: linkRect.bottom - 1 }, expectedElement))
            .then((el) => el || topElement));
    });
}
function getElementFromPoint(point, win, expectedEl) {
    return adapter_1.adapter.getElementExceptUI(point)
        .then((topElement) => {
        // NOTE: when trying to get an element by elementFromPoint in iframe and the target
        // element is under any of shadow-ui elements, you will get null (only in IE).
        // In this case, you should hide a top window's shadow-ui root to obtain an element.
        let resChain = hammerhead_1.Promise.resolve(topElement);
        if (!topElement && is_window_iframe_1.default(win) && point.x > 0 && point.y > 0)
            resChain = resChain.then(() => adapter_1.adapter.getElementExceptUI(point, true));
        return resChain.then((element) => correctTopElementByExpectedElement(element, expectedEl));
    });
}
exports.default = getElementFromPoint;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWVsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhcmVkL2FjdGlvbnMvZ2V0LWVsZW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsd0NBQXFDO0FBQ3JDLGdGQUFzRDtBQUd0RCxhQUFhO0FBQ2Isb0VBQXFFO0FBQ3JFLGFBQWE7QUFDYixzRUFBd0Q7QUFFeEQsU0FBUyxjQUFjLENBQUssVUFBYSxFQUFFLFdBQWM7SUFDckQsT0FBTyxvQkFBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN2RCxJQUFJLENBQUMsQ0FBQyxVQUEwQixFQUFFLEVBQUU7UUFDakMsT0FBTyxVQUFVLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztJQUMzRyxDQUFDLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLG1DQUFtQyxDQUFLLEtBQTZCLEVBQUUsT0FBVztJQUN2RixPQUFPLG9CQUFPLENBQUMsT0FBTyxDQUFDLGlCQUFPLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzlELElBQUksQ0FBQyxDQUFDLFVBQXVCLEVBQUUsRUFBRTtRQUM5QixPQUFPLG9CQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDO2FBQ2hFLElBQUksQ0FBQyxDQUFDLFVBQXVCLEVBQUUsRUFBRSxDQUFDLFVBQVUsSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ2pGLElBQUksQ0FBQyxDQUFDLGVBQTRCLEVBQUUsRUFBRSxDQUFDLGVBQWUsSUFBSSxVQUFV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LENBQUM7U0FDbkMsSUFBSSxDQUFDLENBQUMsVUFBYSxFQUFFLEVBQUU7UUFDcEIsbUZBQW1GO1FBQ25GLDhFQUE4RTtRQUM5RSxvRkFBb0Y7UUFDcEYsSUFBSSxRQUFRLEdBQUcsb0JBQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFM0MsSUFBSSxDQUFDLFVBQVUsSUFBSSwwQkFBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNoRSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxpQkFBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTVFLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQVUsRUFBRSxFQUFFLENBQUMsa0NBQWtDLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDbEcsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBYkQsc0NBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhZGFwdGVyIH0gZnJvbSAnLi4vYWRhcHRlcic7XG5pbXBvcnQgaXNJZnJhbWVXaW5kb3cgZnJvbSAnLi91dGlscy9pcy13aW5kb3ctaWZyYW1lJztcbmltcG9ydCB7IEF4aXNWYWx1ZXNEYXRhIH0gZnJvbSAnLi4vdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCB7IFNoYXJlZFdpbmRvdyB9IGZyb20gJy4uL3R5cGVzJztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCB7IFByb21pc2UsIHV0aWxzIH0gZnJvbSAnLi4vLi4vY2xpZW50L2RyaXZlci9kZXBzL2hhbW1lcmhlYWQnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0ICogYXMgZG9tVXRpbHMgZnJvbSAnLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvZG9tJztcblxuZnVuY3Rpb24gZW5zdXJlSW1hZ2VNYXA8RT4gKGltZ0VsZW1lbnQ6IEUsIGFyZWFFbGVtZW50OiBFKTogUHJvbWlzZTxFPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkb21VdGlscy5jbG9zZXN0KGFyZWFFbGVtZW50LCAnbWFwJykpXG4gICAgICAgIC50aGVuKChtYXBFbGVtZW50OiBIVE1MTWFwRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG1hcEVsZW1lbnQgJiYgbWFwRWxlbWVudC5uYW1lID09PSBkb21VdGlscy5nZXRJbWdNYXBOYW1lKGltZ0VsZW1lbnQpID8gYXJlYUVsZW1lbnQgOiBpbWdFbGVtZW50O1xuICAgICAgICB9KTtcbn1cblxuZnVuY3Rpb24gZmluZEVsZW1lbnRPck5vbkVtcHR5Q2hpbGRGcm9tUG9pbnQ8RT4gKHBvaW50OiBBeGlzVmFsdWVzRGF0YTxudW1iZXI+LCBlbGVtZW50PzogRSk6IFByb21pc2U8RSB8IG51bGw+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFkYXB0ZXIucG9zaXRpb24uZ2V0RWxlbWVudEZyb21Qb2ludChwb2ludCkpXG4gICAgICAgIC50aGVuKCh0b3BFbGVtZW50OiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkb21VdGlscy5jb250YWluc0VsZW1lbnQoZWxlbWVudCwgdG9wRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGNvbnRhaW5zRWw6IEhUTUxFbGVtZW50KSA9PiBjb250YWluc0VsICYmIGRvbVV0aWxzLmdldE5vZGVUZXh0KHRvcEVsZW1lbnQpKVxuICAgICAgICAgICAgICAgIC50aGVuKChpc05vbkVtcHR5Q2hpbGQ6IEhUTUxFbGVtZW50KSA9PiBpc05vbkVtcHR5Q2hpbGQgfHwgdG9wRWxlbWVudCAmJiBkb21VdGlscy5pc05vZGVFcXVhbCh0b3BFbGVtZW50LCBlbGVtZW50KSA/IHRvcEVsZW1lbnQgOiBudWxsKTtcbiAgICAgICAgfSk7XG59XG5cbmZ1bmN0aW9uIGNvcnJlY3RUb3BFbGVtZW50QnlFeHBlY3RlZEVsZW1lbnQ8RT4gKHRvcEVsZW1lbnQ6IEUsIGV4cGVjdGVkRWxlbWVudD86IEUpOiBQcm9taXNlPEU+IHwgRSB7XG4gICAgaWYgKCFleHBlY3RlZEVsZW1lbnQgfHwgIXRvcEVsZW1lbnQgfHwgZG9tVXRpbHMuaXNOb2RlRXF1YWwodG9wRWxlbWVudCwgZXhwZWN0ZWRFbGVtZW50KSlcbiAgICAgICAgcmV0dXJuIHRvcEVsZW1lbnQ7XG5cbiAgICBjb25zdCBpc1RSRUZFbGVtZW50ID0gZG9tVXRpbHMuZ2V0VGFnTmFtZShleHBlY3RlZEVsZW1lbnQpID09PSAndHJlZic7XG5cbiAgICAvLyBOT1RFOiAnZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludCcgY2FuJ3QgZmluZCB0aGVzZSB0eXBlcyBvZiBlbGVtZW50c1xuICAgIGlmIChpc1RSRUZFbGVtZW50KVxuICAgICAgICByZXR1cm4gZXhwZWN0ZWRFbGVtZW50O1xuXG4gICAgLy8gTk9URTogVDI5OTY2NSAtIEluY29ycmVjdCBjbGljayBhdXRvbWF0aW9uIGZvciBpbWFnZXMgd2l0aCBhbiBhc3NvY2lhdGVkIG1hcCBlbGVtZW50IGluIEZpcmVmb3hcbiAgICAvLyBBbGwgYnJvd3NlcnMgcmV0dXJuIHRoZSA8YXJlYT4gZWxlbWVudCBmcm9tIGRvY3VtZW50LmdldEVsZW1lbnRGcm9tUG9pbnQsIGJ1dFxuICAgIC8vIEZpcmVmb3ggcmV0dXJucyB0aGUgPGltZz4gZWxlbWVudC4gV2Ugc2hvdWxkIGFjY29tcGxpc2ggdGhpcyBmb3IgRmlyZWZveCBhcyB3ZWxsLlxuICAgIGNvbnN0IGlzSW1hZ2VNYXBBcmVhID0gZG9tVXRpbHMuZ2V0VGFnTmFtZShleHBlY3RlZEVsZW1lbnQpID09PSAnYXJlYScgJiYgZG9tVXRpbHMuaXNJbWdFbGVtZW50KHRvcEVsZW1lbnQpO1xuXG4gICAgaWYgKHV0aWxzLmJyb3dzZXIuaXNGaXJlZm94ICYmIGlzSW1hZ2VNYXBBcmVhKVxuICAgICAgICByZXR1cm4gZW5zdXJlSW1hZ2VNYXAodG9wRWxlbWVudCwgZXhwZWN0ZWRFbGVtZW50KTtcblxuICAgIC8vIE5PVEU6IHRyeSB0byBmaW5kIGEgbXVsdGktbGluZSBsaW5rIGJ5IGl0cyByZWN0YW5nbGUgKFQxNjM2NzgpXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkb21VdGlscy5jbG9zZXN0KGV4cGVjdGVkRWxlbWVudCwgJ2EnKSlcbiAgICAgICAgLnRoZW4oKGFuY2hvcjogYW55KSA9PiAhIWFuY2hvcilcbiAgICAgICAgLnRoZW4oKGlzTGlua09yQ2hpbGRFeHBlY3RlZDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgaWYgKCFpc0xpbmtPckNoaWxkRXhwZWN0ZWQpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGRvbVV0aWxzLmNvbnRhaW5zRWxlbWVudChleHBlY3RlZEVsZW1lbnQsIHRvcEVsZW1lbnQpKVxuICAgICAgICAgICAgICAgIC50aGVuKChjb250YWluc0VsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiBjb250YWluc0VsZW1lbnQgJiYgZG9tVXRpbHMuZ2V0Tm9kZVRleHQodG9wRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGlzVG9wRWxlbWVudENoaWxkT2ZMaW5rOiBIVE1MRWxlbWVudCkgPT4gIWlzVG9wRWxlbWVudENoaWxkT2ZMaW5rICYmIGRvbVV0aWxzLmdldE5vZGVUZXh0KGV4cGVjdGVkRWxlbWVudCkpO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbigoc2hvdWxkU2VhcmNoRm9yTXVsdGlsaW5lTGluazogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgaWYgKCFzaG91bGRTZWFyY2hGb3JNdWx0aWxpbmVMaW5rKVxuICAgICAgICAgICAgICAgIHJldHVybiB0b3BFbGVtZW50O1xuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFkYXB0ZXIucG9zaXRpb24uZ2V0Q2xpZW50RGltZW5zaW9ucyhleHBlY3RlZEVsZW1lbnQpKVxuICAgICAgICAgICAgICAgIC50aGVuKChsaW5rUmVjdDogYW55KSA9PiBmaW5kRWxlbWVudE9yTm9uRW1wdHlDaGlsZEZyb21Qb2ludCh7IHg6IGxpbmtSZWN0LnJpZ2h0IC0gMSwgeTogbGlua1JlY3QudG9wICsgMSB9LCBleHBlY3RlZEVsZW1lbnQpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChlbDogYW55KSA9PiBlbCB8fCBmaW5kRWxlbWVudE9yTm9uRW1wdHlDaGlsZEZyb21Qb2ludCh7IHg6IGxpbmtSZWN0LmxlZnQgKyAxLCB5OiBsaW5rUmVjdC5ib3R0b20gLSAxIH0sIGV4cGVjdGVkRWxlbWVudCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChlbDogYW55KSA9PiBlbCB8fCB0b3BFbGVtZW50KSk7XG4gICAgICAgIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBnZXRFbGVtZW50RnJvbVBvaW50PEUsIFcgZXh0ZW5kcyBTaGFyZWRXaW5kb3c+IChwb2ludDogQXhpc1ZhbHVlc0RhdGE8bnVtYmVyPiwgd2luOiBXLCBleHBlY3RlZEVsPzogRSk6IFByb21pc2U8RT4ge1xuICAgIHJldHVybiBhZGFwdGVyLmdldEVsZW1lbnRFeGNlcHRVSShwb2ludClcbiAgICAgICAgLnRoZW4oKHRvcEVsZW1lbnQ6IEUpID0+IHtcbiAgICAgICAgICAgIC8vIE5PVEU6IHdoZW4gdHJ5aW5nIHRvIGdldCBhbiBlbGVtZW50IGJ5IGVsZW1lbnRGcm9tUG9pbnQgaW4gaWZyYW1lIGFuZCB0aGUgdGFyZ2V0XG4gICAgICAgICAgICAvLyBlbGVtZW50IGlzIHVuZGVyIGFueSBvZiBzaGFkb3ctdWkgZWxlbWVudHMsIHlvdSB3aWxsIGdldCBudWxsIChvbmx5IGluIElFKS5cbiAgICAgICAgICAgIC8vIEluIHRoaXMgY2FzZSwgeW91IHNob3VsZCBoaWRlIGEgdG9wIHdpbmRvdydzIHNoYWRvdy11aSByb290IHRvIG9idGFpbiBhbiBlbGVtZW50LlxuICAgICAgICAgICAgbGV0IHJlc0NoYWluID0gUHJvbWlzZS5yZXNvbHZlKHRvcEVsZW1lbnQpO1xuXG4gICAgICAgICAgICBpZiAoIXRvcEVsZW1lbnQgJiYgaXNJZnJhbWVXaW5kb3cod2luKSAmJiBwb2ludC54ID4gMCAmJiBwb2ludC55ID4gMClcbiAgICAgICAgICAgICAgICByZXNDaGFpbiA9IHJlc0NoYWluLnRoZW4oKCkgPT4gYWRhcHRlci5nZXRFbGVtZW50RXhjZXB0VUkocG9pbnQsIHRydWUpKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlc0NoYWluLnRoZW4oKGVsZW1lbnQ6IEUpID0+IGNvcnJlY3RUb3BFbGVtZW50QnlFeHBlY3RlZEVsZW1lbnQoZWxlbWVudCwgZXhwZWN0ZWRFbCkpO1xuICAgICAgICB9KTtcbn1cbiJdfQ==