"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../../adapter");
const next_tick_1 = __importDefault(require("../../utils/next-tick"));
const settings_1 = __importDefault(require("./settings"));
const options_1 = require("../../../test-run/commands/options");
const last_hovered_element_holder_1 = __importDefault(require("./last-hovered-element-holder"));
const hammerhead_1 = require("../../../client/driver/deps/hammerhead");
// @ts-ignore
const testcafe_core_1 = require("../../../client/automation/deps/testcafe-core");
const MOVE_REQUEST_CMD = 'automation|move|request';
const MOVE_RESPONSE_CMD = 'automation|move|response';
const get_automation_point_1 = __importDefault(require("../utils/get-automation-point"));
const axis_values_1 = __importDefault(require("../../utils/values/axis-values"));
const promise_1 = require("../../utils/promise");
const get_device_point_1 = __importDefault(require("../utils/get-device-point"));
class MoveAutomation {
    constructor(el, offset, moveOptions, win, cursor) {
        this.touchMode = hammerhead_1.utils.featureDetection.isTouchDevice;
        this.moveEvent = this.touchMode ? 'touchmove' : 'mousemove';
        this.automationSettings = new settings_1.default(moveOptions.speed);
        this.cursorSpeed = this._getCursorSpeed();
        this.element = el;
        this.window = win;
        this.offset = offset;
        this.cursor = cursor;
        this.minMovingTime = moveOptions.minMovingTime || 0;
        this.modifiers = moveOptions.modifiers || {};
        this.skipScrolling = moveOptions.skipScrolling;
        this.skipDefaultDragBehavior = moveOptions.skipDefaultDragBehavior;
        this.speed = moveOptions.speed;
        this.firstMovingStepOccured = false;
    }
    static async create(el, moveOptions, win, cursor) {
        const { element, offset } = await MoveAutomation.getTarget(el, win, new axis_values_1.default(moveOptions.offsetX, moveOptions.offsetY));
        return new MoveAutomation(element, offset, moveOptions, win, cursor);
    }
    static getTarget(element, window, offset) {
        // NOTE: if the target point (considering offsets) is out of
        // the element change the target element to the document element
        return hammerhead_1.Promise.resolve(adapter_1.adapter.position.containsOffset(element, offset.x, offset.y))
            .then((containsOffset) => {
            if (!containsOffset) {
                return hammerhead_1.Promise.all([
                    get_automation_point_1.default(element, offset),
                    testcafe_core_1.domUtils.getDocumentElement(window),
                ])
                    .then(([point, docEl]) => ({ element: docEl, offset: point }));
            }
            return { element, offset };
        });
    }
    _getCursorSpeed() {
        return this.automationSettings.cursorSpeed;
    }
    _getTargetClientPoint() {
        return hammerhead_1.Promise.resolve(adapter_1.adapter.style.getElementScroll(this.element))
            .then((scroll) => {
            if (testcafe_core_1.domUtils.isHtmlElement(this.element)) {
                return axis_values_1.default.create(this.offset)
                    .sub(axis_values_1.default.create(scroll))
                    .round(Math.round);
            }
            return hammerhead_1.Promise.resolve(adapter_1.adapter.position.getClientPosition(this.element))
                .then((clientPosition) => {
                const isDocumentBody = testcafe_core_1.domUtils.isBodyElement(this.element);
                // @ts-ignore
                const clientPoint = axis_values_1.default.create(clientPosition).add(this.offset);
                if (!isDocumentBody)
                    clientPoint.sub(axis_values_1.default.create(scroll));
                return clientPoint.round(Math.floor);
            });
        });
    }
    _getEventSequenceOptions(currPosition) {
        const button = adapter_1.adapter.event.BUTTONS_PARAMETER.noButton;
        return get_device_point_1.default(currPosition)
            .then((devicePoint) => {
            const eventOptions = {
                clientX: currPosition.x,
                clientY: currPosition.y,
                screenX: devicePoint === null || devicePoint === void 0 ? void 0 : devicePoint.x,
                screenY: devicePoint === null || devicePoint === void 0 ? void 0 : devicePoint.y,
                buttons: button,
                ctrl: this.modifiers.ctrl,
                alt: this.modifiers.alt,
                shift: this.modifiers.shift,
                meta: this.modifiers.meta,
            };
            return { eventOptions, eventSequenceOptions: { moveEvent: this.moveEvent } };
        });
    }
    async _runEventSequence(currentElement, { eventOptions, eventSequenceOptions }) {
        const eventSequence = await adapter_1.adapter.createEventSequence(false, this.firstMovingStepOccured, eventSequenceOptions);
        return eventSequence.run(currentElement, last_hovered_element_holder_1.default.get(), eventOptions, null, null);
    }
    _emulateEvents(currentElement, currPosition) {
        return this._getEventSequenceOptions(currPosition)
            .then((options) => {
            return this._runEventSequence(currentElement, options);
        })
            .then(() => {
            this.firstMovingStepOccured = true;
            last_hovered_element_holder_1.default.set(currentElement);
        });
    }
    _movingStep(currPosition) {
        return this.cursor.move(currPosition)
            .then(() => adapter_1.adapter.getElementExceptUI(this.cursor.getPosition()))
            // NOTE: in touch mode, events are simulated for the element for which mousedown was simulated (GH-372)
            .then((topElement) => {
            const currentElement = this._getCorrectedTopElement(topElement);
            // NOTE: it can be null in IE
            if (!currentElement)
                return null;
            return this._emulateEvents(currentElement, currPosition);
        })
            .then(next_tick_1.default);
    }
    _getCorrectedTopElement(topElement) {
        return topElement;
    }
    _move(endPoint) {
        const startPoint = this.cursor.getPosition();
        const distance = axis_values_1.default.create(endPoint).sub(startPoint);
        const startTime = hammerhead_1.nativeMethods.dateNow();
        const movingTime = Math.max(Math.max(Math.abs(distance.x), Math.abs(distance.y)) / this.cursorSpeed, this.minMovingTime);
        let currPosition = axis_values_1.default.create(startPoint);
        let isFirstStep = true;
        return promise_1.whilst(() => !currPosition.eql(endPoint), () => {
            if (this._needMoveCursorImmediately())
                currPosition = axis_values_1.default.create(endPoint);
            else if (isFirstStep) {
                isFirstStep = false;
                // NOTE: the mousemove event can't be simulated at the point where the cursor
                // was located at the start. Therefore, we add a minimal distance 1 px.
                currPosition.add({
                    x: distance.x > 0 ? 1 : -1,
                    y: distance.y > 0 ? 1 : -1,
                });
            }
            else {
                const progress = Math.min((hammerhead_1.nativeMethods.dateNow() - startTime) / movingTime, 1);
                currPosition = axis_values_1.default.create(distance).mul(progress).add(startPoint).round(Math.floor);
            }
            return this._movingStep(currPosition);
        });
    }
    //
    _needMoveCursorImmediately() {
        return this.touchMode;
    }
    _scroll() {
        if (this.skipScrolling)
            return hammerhead_1.Promise.resolve(false);
        const scrollOptions = new options_1.ScrollOptions({ offsetX: this.offset.x, offsetY: this.offset.y }, false);
        return adapter_1.adapter.scroll(this.element, scrollOptions);
    }
    _moveToCurrentFrame(endPoint) {
        if (this.cursor.isActive(this.window))
            return hammerhead_1.Promise.resolve();
        const { x, y } = this.cursor.getPosition();
        const activeWindow = this.cursor.getActiveWindow(this.window);
        let iframe = null;
        let iframeUnderCursor = null;
        const msg = {
            cmd: MOVE_REQUEST_CMD,
            startX: x,
            startY: y,
            endX: endPoint.x,
            endY: endPoint.y,
            modifiers: this.modifiers,
            speed: this.speed,
        };
        return hammerhead_1.Promise.resolve()
            .then(() => {
            if (activeWindow.parent === this.window) {
                return hammerhead_1.Promise.resolve(testcafe_core_1.domUtils.findIframeByWindow(activeWindow))
                    .then((frame) => {
                    iframe = frame;
                    return hammerhead_1.Promise.resolve(adapter_1.adapter.position.getIframeClientCoordinates(frame))
                        .then((rect) => {
                        msg.left = rect.left;
                        msg.top = rect.top;
                        msg.right = rect.right;
                        msg.bottom = rect.bottom;
                    });
                });
            }
            return void 0;
        })
            .then(() => {
            return adapter_1.adapter.getElementExceptUI(this.cursor.getPosition());
        })
            .then((topElement) => {
            iframeUnderCursor = topElement === iframe;
            if (activeWindow.parent === this.window)
                msg.iframeUnderCursor = iframeUnderCursor;
            return adapter_1.adapter.sendRequestToFrame(msg, MOVE_RESPONSE_CMD, activeWindow);
        })
            .then((message) => {
            this.cursor.setActiveWindow(this.window);
            if (iframeUnderCursor || testcafe_core_1.domUtils.isIframeWindow(this.window))
                return this.cursor.move(message);
            return void 0;
        });
    }
    run() {
        return this._scroll()
            .then(() => hammerhead_1.Promise.all([
            this._getTargetClientPoint(),
            adapter_1.adapter.style.getWindowDimensions(this.window),
        ]))
            .then(([endPoint, boundary]) => {
            if (!boundary.contains(endPoint))
                return void 0;
            return this._moveToCurrentFrame(endPoint)
                .then(() => this._move(endPoint));
        });
    }
}
exports.default = MoveAutomation;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW92ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zaGFyZWQvYWN0aW9ucy9hdXRvbWF0aW9ucy9tb3ZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMkNBQXdDO0FBRXhDLHNFQUE2QztBQUM3QywwREFBNEM7QUFDNUMsZ0VBSTRDO0FBQzVDLGdHQUFxRTtBQUVyRSx1RUFPZ0Q7QUFFaEQsYUFBYTtBQUNiLGlGQUF5RTtBQUV6RSxNQUFNLGdCQUFnQixHQUFJLHlCQUF5QixDQUFDO0FBQ3BELE1BQU0saUJBQWlCLEdBQUcsMEJBQTBCLENBQUM7QUFFckQseUZBQStEO0FBQy9ELGlGQUE0RTtBQUc1RSxpREFBNkM7QUFDN0MsaUZBQXVEO0FBT3ZELE1BQXFCLGNBQWM7SUFtQi9CLFlBQXVCLEVBQUssRUFBRSxNQUE4QixFQUFFLFdBQXdCLEVBQUUsR0FBTSxFQUFFLE1BQWlCO1FBQzdHLElBQUksQ0FBQyxTQUFTLEdBQUcsa0JBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUM7UUFDdEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUU1RCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFcEUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLE1BQU0sR0FBSSxHQUFHLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBSSxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBSSxNQUFNLENBQUM7UUFFdEIsSUFBSSxDQUFDLGFBQWEsR0FBYSxXQUFXLENBQUMsYUFBYSxJQUFJLENBQUMs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LENBQUM7Z0JBQ3pELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFckMsT0FBTyxLQUFLLENBQUMsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFTSxHQUFHO1FBQ04sT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFO2FBQ2hCLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxvQkFBTyxDQUFDLEdBQUcsQ0FBQztZQUNwQixJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDNUIsaUJBQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUNqRCxDQUFDLENBQUM7YUFDRixJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQWEsRUFBRSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztnQkFDNUIsT0FBTyxLQUFLLENBQUMsQ0FBQztZQUVsQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUM7aUJBQ3BDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0NBQ0o7QUFsUkQsaUNBa1JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWRhcHRlciB9IGZyb20gJy4uLy4uL2FkYXB0ZXInO1xuXG5pbXBvcnQgbmV4dFRpY2sgZnJvbSAnLi4vLi4vdXRpbHMvbmV4dC10aWNrJztcbmltcG9ydCBBdXRvbWF0aW9uU2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQge1xuICAgIE1vZGlmaWVycyxcbiAgICBNb3ZlT3B0aW9ucyxcbiAgICBTY3JvbGxPcHRpb25zLFxufSBmcm9tICcuLi8uLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vcHRpb25zJztcbmltcG9ydCBsYXN0SG92ZXJlZEVsZW1lbnRIb2xkZXIgZnJvbSAnLi9sYXN0LWhvdmVyZWQtZWxlbWVudC1ob2xkZXInO1xuXG5pbXBvcnQge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBuYXRpdmVNZXRob2RzLFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBQcm9taXNlLFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICB1dGlscyxcbn0gZnJvbSAnLi4vLi4vLi4vY2xpZW50L2RyaXZlci9kZXBzL2hhbW1lcmhlYWQnO1xuXG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgeyBkb21VdGlscyB9IGZyb20gJy4uLy4uLy4uL2NsaWVudC9hdXRvbWF0aW9uL2RlcHMvdGVzdGNhZmUtY29yZSc7XG5cbmNvbnN0IE1PVkVfUkVRVUVTVF9DTUQgID0gJ2F1dG9tYXRpb258bW92ZXxyZXF1ZXN0JztcbmNvbnN0IE1PVkVfUkVTUE9OU0VfQ01EID0gJ2F1dG9tYXRpb258bW92ZXxyZXNwb25zZSc7XG5cbmltcG9ydCBnZXRBdXRvbWF0aW9uUG9pbnQgZnJvbSAnLi4vdXRpbHMvZ2V0LWF1dG9tYXRpb24tcG9pbnQnO1xuaW1wb3J0IEF4aXNWYWx1ZXMsIHsgQXhpc1ZhbHVlc0RhdGEgfSBmcm9tICcuLi8uLi91dGlscy92YWx1ZXMvYXhpcy12YWx1ZXMnO1xuaW1wb3J0IHsgU2hhcmVkV2luZG93IH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IEN1cnNvciBmcm9tICcuLi9jdXJzb3InO1xuaW1wb3J0IHsgd2hpbHN0IH0gZnJvbSAnLi4vLi4vdXRpbHMvcHJvbWlzZSc7XG5pbXBvcnQgZ2V0RGV2aWNlUG9pbnQgZnJvbSAnLi4vdXRpbHMvZ2V0LWRldmljZS1wb2ludCc7XG5cbmludGVyZmFjZSBNb3ZlQXV0b21hdGlvblRhcmdldDxFPiB7XG4gICAgZWxlbWVudDogRTtcbiAgICBvZmZzZXQ6IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj47XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vdmVBdXRvbWF0aW9uPEUsIFcgZXh0ZW5kcyBTaGFyZWRXaW5kb3c+IHtcbiAgICBwcml2YXRlIHRvdWNoTW9kZTogYm9vbGVhbjtcbiAgICBwcml2YXRlIG1vdmVFdmVudDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBhdXRvbWF0aW9uU2V0dGluZ3M6IEF1dG9tYXRpb25TZXR0aW5ncztcblxuICAgIHByaXZhdGUgZWxlbWVudDogRTtcbiAgICBwcml2YXRlIHdpbmRvdzogVztcbiAgICBwcml2YXRlIG9mZnNldDogQXhpc1ZhbHVlc0RhdGE8bnVtYmVyPjtcbiAgICBwcml2YXRlIGN1cnNvcjogQ3Vyc29yPFc+O1xuICAgIHByaXZhdGUgc3BlZWQ6IG51bWJlcjtcbiAgICBwcml2YXRlIGN1cnNvclNwZWVkOiBudW1iZXI7XG5cbiAgICBwcml2YXRlIG1pbk1vdmluZ1RpbWU6IG51bWJlcjtcbiAgICBwcml2YXRlIG1vZGlmaWVyczogTW9kaWZpZXJzO1xuICAgIHByaXZhdGUgc2tpcFNjcm9sbGluZzogYm9vbGVhbjtcbiAgICBwcml2YXRlIHNraXBEZWZhdWx0RHJhZ0JlaGF2aW9yOiBib29sZWFuO1xuICAgIHByaXZhdGUgZmlyc3RNb3ZpbmdTdGVwT2NjdXJlZDogYm9vbGVhbjtcblxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvciAoZWw6IEUsIG9mZnNldDogQXhpc1ZhbHVlc0RhdGE8bnVtYmVyPiwgbW92ZU9wdGlvbnM6IE1vdmVPcHRpb25zLCB3aW46IFcsIGN1cnNvcjogQ3Vyc29yPFc+KSB7XG4gICAgICAgIHRoaXMudG91Y2hNb2RlID0gdXRpbHMuZmVhdHVyZURldGVjdGlvbi5pc1RvdWNoRGV2aWNlO1xuICAgICAgICB0aGlzLm1vdmVFdmVudCA9IHRoaXMudG91Y2hNb2RlID8gJ3RvdWNobW92ZScgOiAnbW91c2Vtb3ZlJztcblxuICAgICAgICB0aGlzLmF1dG9tYXRpb25TZXR0aW5ncyA9IG5ldyBBdXRvbWF0aW9uU2V0dGluZ3MobW92ZU9wdGlvbnMuc3BlZWQpO1xuXG4gICAgICAgIHRoaXMuY3Vyc29yU3BlZWQgPSB0aGlzLl9nZXRDdXJzb3JTcGVlZCgpO1xuXG4gICAgICAgIHRoaXMuZWxlbWVudCA9IGVsO1xuICAgICAgICB0aGlzLndpbmRvdyAgPSB3aW47XG4gICAgICAgIHRoaXMub2Zmc2V0ICA9IG9mZnNldDtcbiAgICAgICAgdGhpcy5jdXJzb3IgID0gY3Vyc29yO1xuXG4gICAgICAgIHRoaXMubWluTW92aW5nVGltZSAgICAgICAgICAgPSBtb3ZlT3B0aW9ucy5taW5Nb3ZpbmdUaW1lIHx8IDA7XG4gICAgICAgIHRoaXMubW9kaWZpZXJzICAgICAgICAgICAgICAgPSBtb3ZlT3B0aW9ucy5tb2RpZmllcnMgfHwge307XG4gICAgICAgIHRoaXMuc2tpcFNjcm9sbGluZyAgICAgICAgICAgPSBtb3ZlT3B0aW9ucy5za2lwU2Nyb2xsaW5nO1xuICAgICAgICB0aGlzLnNraXBEZWZhdWx0RHJhZ0JlaGF2aW9yID0gbW92ZU9wdGlvbnMuc2tpcERlZmF1bHREcmFnQmVoYXZpb3I7XG4gICAgICAgIHRoaXMuc3BlZWQgICAgICAgICAgICAgICAgICAgPSBtb3ZlT3B0aW9ucy5zcGVlZDtcblxuICAgICAgICB0aGlzLmZpcnN0TW92aW5nU3RlcE9jY3VyZWQgID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBjcmVhdGU8RSwgVyBleHRlbmRzIFNoYXJlZFdpbmRvdz4gKGVsOiBFLCBtb3ZlT3B0aW9uczogTW92ZU9wdGlvbnMsIHdpbjogVywgY3Vyc29yOiBDdXJzb3I8Vz4pOiBQcm9taXNlPE1vdmVBdXRvbWF0aW9uPEUsIFc+PiB7XG4gICAgICAgIGNvbnN0IHsgZWxlbWVudCwgb2Zmc2V0IH0gPSBhd2FpdCBNb3ZlQXV0b21hdGlvbi5nZXRUYXJnZXQoZWwsIHdpbiwgbmV3IEF4aXNWYWx1ZXMobW92ZU9wdGlvbnMub2Zmc2V0WCwgbW92ZU9wdGlvbnMub2Zmc2V0WSkpO1xuXG4gICAgICAgIHJldHVybiBuZXcgTW92ZUF1dG9tYXRpb24oZWxlbWVudCwgb2Zmc2V0LCBtb3ZlT3B0aW9ucywgd2luLCBjdXJzb3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGdldFRhcmdldDxFLCBXPiAoZWxlbWVudDogRSwgd2luZG93OiBXLCBvZmZzZXQ6IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4pOiBQcm9taXNlPE1vdmVBdXRvbWF0aW9uVGFyZ2V0PEU+PiB7XG4gICAgICAgIC8vIE5PVEU6IGlmIHRoZSB0YXJnZXQgcG9pbnQgKGNvbnNpZGVyaW5nIG9mZnNldHMpIGlzIG91dCBvZlxuICAgICAgICAvLyB0aGUgZWxlbWVudCBjaGFuZ2UgdGhlIHRhcmdldCBlbGVtZW50IHRvIHRoZSBkb2N1bWVudCBlbGVtZW50XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYWRhcHRlci5wb3NpdGlvbi5jb250YWluc09mZnNldChlbGVtZW50LCBvZmZzZXQueCwgb2Zmc2V0LnkpKVxuICAgICAgICAgICAgLnRoZW4oKGNvbnRhaW5zT2Zmc2V0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb250YWluc09mZnNldCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICAgICAgZ2V0QXV0b21hdGlvblBvaW50KGVsZW1lbnQsIG9mZnNldCksXG4gICAgICAgICAgICAgICAgICAgICAgICBkb21VdGlscy5nZXREb2N1bWVudEVsZW1lbnQod2luZG93KSxcbiAgICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChbcG9pbnQsIGRvY0VsXTogW2FueSwgSFRNTEVsZW1lbnRdKSA9PiAoeyBlbGVtZW50OiBkb2NFbCwgb2Zmc2V0OiBwb2ludCB9KSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgZWxlbWVudCwgb2Zmc2V0IH07XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRDdXJzb3JTcGVlZCAoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0b21hdGlvblNldHRpbmdzLmN1cnNvclNwZWVkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFRhcmdldENsaWVudFBvaW50ICgpOiBQcm9taXNlPEF4aXNWYWx1ZXM8bnVtYmVyPj4ge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFkYXB0ZXIuc3R5bGUuZ2V0RWxlbWVudFNjcm9sbCh0aGlzLmVsZW1lbnQpKVxuICAgICAgICAgICAgLnRoZW4oKHNjcm9sbDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbVV0aWxzLmlzSHRtbEVsZW1lbnQodGhpcy5lbGVtZW50KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gQXhpc1ZhbHVlcy5jcmVhdGUodGhpcy5vZmZzZXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3ViKEF4aXNWYWx1ZXMuY3JlYXRlKHNjcm9sbCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAucm91bmQoTWF0aC5yb3VuZCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhZGFwdGVyLnBvc2l0aW9uLmdldENsaWVudFBvc2l0aW9uKHRoaXMuZWxlbWVudCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChjbGllbnRQb3NpdGlvbjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0RvY3VtZW50Qm9keSA9IGRvbVV0aWxzLmlzQm9keUVsZW1lbnQodGhpcy5lbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsaWVudFBvaW50ID0gQXhpc1ZhbHVlcy5jcmVhdGUoY2xpZW50UG9zaXRpb24pLmFkZCh0aGlzLm9mZnNldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNEb2N1bWVudEJvZHkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50UG9pbnQuc3ViKEF4aXNWYWx1ZXMuY3JlYXRlKHNjcm9sbCkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xpZW50UG9pbnQucm91bmQoTWF0aC5mbG9vcik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0RXZlbnRTZXF1ZW5jZU9wdGlvbnMgKGN1cnJQb3NpdGlvbjogQXhpc1ZhbHVlczxudW1iZXI+KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgYnV0dG9uID0gYWRhcHRlci5ldmVudC5CVVRUT05TX1BBUkFNRVRFUi5ub0J1dHRvbjtcblxuICAgICAgICByZXR1cm4gZ2V0RGV2aWNlUG9pbnQoY3VyclBvc2l0aW9uKVxuICAgICAgICAgICAgLnRoZW4oKGRldmljZVBvaW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBldmVudE9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgICAgIGNsaWVudFg6IGN1cnJQb3NpdGlvbi54LFxuICAgICAgICAgICAgICAgICAgICBjbGllbnRZOiBjdXJyUG9zaXRpb24ueSxcbiAgICAgICAgICAgICAgICAgICAgc2NyZWVuWDogZGV2aWNlUG9pbnQ/LngsXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblk6IGRldmljZVBvaW50Py55LFxuICAgICAgICAgICAgICAgICAgICBidXR0b25zOiBidXR0b24sXG4gICAgICAgICAgICAgICAgICAgIGN0cmw6ICAgIHRoaXMubW9kaWZpZXJzLmN0cmwsXG4gICAgICAgICAgICAgICAgICAgIGFsdDogICAgIHRoaXMubW9kaWZpZXJzLmFsdCxcbiAgICAgICAgICAgICAgICAgICAgc2hpZnQ6ICAgdGhpcy5tb2RpZmllcnMuc2hpZnQsXG4gICAgICAgICAgICAgICAgICAgIG1ldGE6ICAgIHRoaXMubW9kaWZpZXJzLm1ldGEsXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB7IGV2ZW50T3B0aW9ucywgZXZlbnRTZXF1ZW5jZU9wdGlvbnM6IHsgbW92ZUV2ZW50OiB0aGlzLm1vdmVFdmVudCB9IH07XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9ydW5FdmVudFNlcXVlbmNlIChjdXJyZW50RWxlbWVudDogRWxlbWVudCwgeyBldmVudE9wdGlvbnMsIGV2ZW50U2VxdWVuY2VPcHRpb25zIH06IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGV2ZW50U2VxdWVuY2UgPSBhd2FpdCBhZGFwdGVyLmNyZWF0ZUV2ZW50U2VxdWVuY2UoZmFsc2UsIHRoaXMuZmlyc3RNb3ZpbmdTdGVwT2NjdXJlZCwgZXZlbnRTZXF1ZW5jZU9wdGlvbnMpO1xuXG4gICAgICAgIHJldHVybiBldmVudFNlcXVlbmNlLnJ1bihcbiAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50LFxuICAgICAgICAgICAgbGFzdEhvdmVyZWRFbGVtZW50SG9sZGVyLmdldCgpLFxuICAgICAgICAgICAgZXZlbnRPcHRpb25zLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIG51bGxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9lbXVsYXRlRXZlbnRzIChjdXJyZW50RWxlbWVudDogRWxlbWVudCwgY3VyclBvc2l0aW9uOiBBeGlzVmFsdWVzPG51bWJlcj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldEV2ZW50U2VxdWVuY2VPcHRpb25zKGN1cnJQb3NpdGlvbilcbiAgICAgICAgICAgIC50aGVuKChvcHRpb25zOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVuRXZlbnRTZXF1ZW5jZShjdXJyZW50RWxlbWVudCwgb3B0aW9ucyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZmlyc3RNb3ZpbmdTdGVwT2NjdXJlZCA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICBsYXN0SG92ZXJlZEVsZW1lbnRIb2xkZXIuc2V0KGN1cnJlbnRFbGVtZW50KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgX21vdmluZ1N0ZXAgKGN1cnJQb3NpdGlvbjogQXhpc1ZhbHVlczxudW1iZXI+KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnNvci5tb3ZlKGN1cnJQb3NpdGlvbilcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGFkYXB0ZXIuZ2V0RWxlbWVudEV4Y2VwdFVJKHRoaXMuY3Vyc29yLmdldFBvc2l0aW9uKCkpKVxuICAgICAgICAgICAgLy8gTk9URTogaW4gdG91Y2ggbW9kZSwgZXZlbnRzIGFyZSBzaW11bGF0ZWQgZm9yIHRoZSBlbGVtZW50IGZvciB3aGljaCBtb3VzZWRvd24gd2FzIHNpbXVsYXRlZCAoR0gtMzcyKVxuICAgICAgICAgICAgLnRoZW4oKHRvcEVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudEVsZW1lbnQgPSB0aGlzLl9nZXRDb3JyZWN0ZWRUb3BFbGVtZW50KHRvcEVsZW1lbnQpO1xuXG4gICAgICAgICAgICAgICAgLy8gTk9URTogaXQgY2FuIGJlIG51bGwgaW4gSUVcbiAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnRFbGVtZW50KVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbXVsYXRlRXZlbnRzKGN1cnJlbnRFbGVtZW50LCBjdXJyUG9zaXRpb24pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKG5leHRUaWNrKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRDb3JyZWN0ZWRUb3BFbGVtZW50ICh0b3BFbGVtZW50OiBFbGVtZW50KTogRWxlbWVudCB7XG4gICAgICAgIHJldHVybiB0b3BFbGVtZW50O1xuICAgIH1cblxuICAgIHByaXZhdGUgX21vdmUgKGVuZFBvaW50OiBBeGlzVmFsdWVzPG51bWJlcj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRQb2ludCA9IHRoaXMuY3Vyc29yLmdldFBvc2l0aW9uKCk7XG4gICAgICAgIGNvbnN0IGRpc3RhbmNlICAgPSBBeGlzVmFsdWVzLmNyZWF0ZShlbmRQb2ludCkuc3ViKHN0YXJ0UG9pbnQpO1xuICAgICAgICBjb25zdCBzdGFydFRpbWUgID0gbmF0aXZlTWV0aG9kcy5kYXRlTm93KCk7XG4gICAgICAgIGNvbnN0IG1vdmluZ1RpbWUgPSBNYXRoLm1heChNYXRoLm1heChNYXRoLmFicyhkaXN0YW5jZS54KSwgTWF0aC5hYnMoZGlzdGFuY2UueSkpIC8gdGhpcy5jdXJzb3JTcGVlZCwgdGhpcy5taW5Nb3ZpbmdUaW1lKTtcbiAgICAgICAgbGV0IGN1cnJQb3NpdGlvbiA9IEF4aXNWYWx1ZXMuY3JlYXRlKHN0YXJ0UG9pbnQpO1xuICAgICAgICBsZXQgaXNGaXJzdFN0ZXAgID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gd2hpbHN0KCgpID0+ICFjdXJyUG9zaXRpb24uZXFsKGVuZFBvaW50KSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX25lZWRNb3ZlQ3Vyc29ySW1tZWRpYXRlbHkoKSlcbiAgICAgICAgICAgICAgICBjdXJyUG9zaXRpb24gPSBBeGlzVmFsdWVzLmNyZWF0ZShlbmRQb2ludCk7XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKGlzRmlyc3RTdGVwKSB7XG4gICAgICAgICAgICAgICAgaXNGaXJzdFN0ZXAgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIC8vIE5PVEU6IHRoZSBtb3VzZW1vdmUgZXZlbnQgY2FuJ3QgYmUgc2ltdWxhdGVkIGF0IHRoZSBwb2ludCB3aGVyZSB0aGUgY3Vyc29yXG4gICAgICAgICAgICAgICAgLy8gd2FzIGxvY2F0ZWQgYXQgdGhlIHN0YXJ0LiBUaGVyZWZvcmUsIHdlIGFkZCBhIG1pbmltYWwgZGlzdGFuY2UgMSBweC5cbiAgICAgICAgICAgICAgICBjdXJyUG9zaXRpb24uYWRkKHtcbiAgICAgICAgICAgICAgICAgICAgeDogZGlzdGFuY2UueCA+IDAgPyAxIDogLTEsXG4gICAgICAgICAgICAgICAgICAgIHk6IGRpc3RhbmNlLnkgPiAwID8gMSA6IC0xLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigobmF0aXZlTWV0aG9kcy5kYXRlTm93KCkgLSBzdGFydFRpbWUpIC8gbW92aW5nVGltZSwgMSk7XG5cbiAgICAgICAgICAgICAgICBjdXJyUG9zaXRpb24gPSBBeGlzVmFsdWVzLmNyZWF0ZShkaXN0YW5jZSkubXVsKHByb2dyZXNzKS5hZGQoc3RhcnRQb2ludCkucm91bmQoTWF0aC5mbG9vcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb3ZpbmdTdGVwKGN1cnJQb3NpdGlvbik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvL1xuICAgIHByaXZhdGUgX25lZWRNb3ZlQ3Vyc29ySW1tZWRpYXRlbHkgKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy50b3VjaE1vZGU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2Nyb2xsICgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgaWYgKHRoaXMuc2tpcFNjcm9sbGluZylcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuXG4gICAgICAgIGNvbnN0IHNjcm9sbE9wdGlvbnMgPSBuZXcgU2Nyb2xsT3B0aW9ucyh7IG9mZnNldFg6IHRoaXMub2Zmc2V0LngsIG9mZnNldFk6IHRoaXMub2Zmc2V0LnkgfSwgZmFsc2UpO1xuXG4gICAgICAgIHJldHVybiBhZGFwdGVyLnNjcm9sbCh0aGlzLmVsZW1lbnQsIHNjcm9sbE9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX21vdmVUb0N1cnJlbnRGcmFtZSAoZW5kUG9pbnQ6IEF4aXNWYWx1ZXM8bnVtYmVyPik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5jdXJzb3IuaXNBY3RpdmUodGhpcy53aW5kb3cpKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIGNvbnN0IHsgeCwgeSB9ICAgICAgICA9IHRoaXMuY3Vyc29yLmdldFBvc2l0aW9uKCk7XG4gICAgICAgIGNvbnN0IGFjdGl2ZVdpbmRvdyAgICA9IHRoaXMuY3Vyc29yLmdldEFjdGl2ZVdpbmRvdyh0aGlzLndpbmRvdyk7XG4gICAgICAgIGxldCBpZnJhbWU6IGFueSAgICAgICA9IG51bGw7XG4gICAgICAgIGxldCBpZnJhbWVVbmRlckN1cnNvcjogYm9vbGVhbiB8IG51bGwgPSBudWxsO1xuXG4gICAgICAgIGNvbnN0IG1zZzogYW55ID0ge1xuICAgICAgICAgICAgY21kOiAgICAgICBNT1ZFX1JFUVVFU1RfQ01ELFxuICAgICAgICAgICAgc3RhcnRYOiAgICB4LFxuICAgICAgICAgICAgc3RhcnRZOiAgICB5LFxuICAgICAgICAgICAgZW5kWDogICAgICBlbmRQb2ludC54LFxuICAgICAgICAgICAgZW5kWTogICAgICBlbmRQb2ludC55LFxuICAgICAgICAgICAgbW9kaWZpZXJzOiB0aGlzLm1vZGlmaWVycyxcbiAgICAgICAgICAgIHNwZWVkOiAgICAgdGhpcy5zcGVlZCxcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlV2luZG93LnBhcmVudCA9PT0gdGhpcy53aW5kb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkb21VdGlscy5maW5kSWZyYW1lQnlXaW5kb3coYWN0aXZlV2luZG93KSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChmcmFtZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWZyYW1lID0gZnJhbWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFkYXB0ZXIucG9zaXRpb24uZ2V0SWZyYW1lQ2xpZW50Q29vcmRpbmF0ZXMoZnJhbWUpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVjdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cubGVmdCAgID0gcmVjdC5sZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLnRvcCAgICA9IHJlY3QudG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnLnJpZ2h0ICA9IHJlY3QucmlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtc2cuYm90dG9tID0gcmVjdC5ib3R0b207XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFkYXB0ZXIuZ2V0RWxlbWVudEV4Y2VwdFVJKHRoaXMuY3Vyc29yLmdldFBvc2l0aW9uKCkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCh0b3BFbGVtZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZnJhbWVVbmRlckN1cnNvciA9IHRvcEVsZW1lbnQgPT09IGlmcmFtZTtcblxuICAgICAgICAgICAgICAgIGlmIChhY3RpdmVXaW5kb3cucGFyZW50ID09PSB0aGlzLndpbmRvdylcbiAgICAgICAgICAgICAgICAgICAgbXNnLmlmcmFtZVVuZGVyQ3Vyc29yID0gaWZyYW1lVW5kZXJDdXJzb3I7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gYWRhcHRlci5zZW5kUmVxdWVzdFRvRnJhbWUobXNnLCBNT1ZFX1JFU1BPTlNFX0NNRCwgYWN0aXZlV2luZG93KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigobWVzc2FnZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJzb3Iuc2V0QWN0aXZlV2luZG93KHRoaXMud2luZG93KTtcblxuICAgICAgICAgICAgICAgIGlmIChpZnJhbWVVbmRlckN1cnNvciB8fCBkb21VdGlscy5pc0lmcmFtZVdpbmRvdyh0aGlzLndpbmRvdykpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnNvci5tb3ZlKG1lc3NhZ2UpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBydW4gKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICB0aGlzLl9nZXRUYXJnZXRDbGllbnRQb2ludCgpLFxuICAgICAgICAgICAgICAgIGFkYXB0ZXIuc3R5bGUuZ2V0V2luZG93RGltZW5zaW9ucyh0aGlzLndpbmRvdyksXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgICAgIC50aGVuKChbZW5kUG9pbnQsIGJvdW5kYXJ5XTogW2FueSwgYW55XSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghYm91bmRhcnkuY29udGFpbnMoZW5kUG9pbnQpKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vdmVUb0N1cnJlbnRGcmFtZShlbmRQb2ludClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fbW92ZShlbmRQb2ludCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxufVxuIl19