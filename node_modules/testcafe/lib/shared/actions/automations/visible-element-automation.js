"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const adapter_1 = require("../../adapter");
const get_automation_point_1 = __importDefault(require("../utils/get-automation-point"));
const screen_point_to_client_1 = __importDefault(require("../utils/screen-point-to-client"));
const get_device_point_1 = __importDefault(require("../utils/get-device-point"));
const offsets_1 = require("../utils/offsets");
const get_element_1 = __importDefault(require("../../../shared/actions/get-element"));
const automation_errors_1 = __importDefault(require("../../../shared/errors/automation-errors"));
const settings_1 = __importDefault(require("../../../shared/actions/automations/settings"));
const move_1 = __importDefault(require("./move"));
const delay_1 = __importDefault(require("../../utils/delay"));
const event_emitter_1 = __importDefault(require("../../../shared/utils/event-emitter"));
const options_1 = require("../../../test-run/commands/options");
// @ts-ignore
const hammerhead_1 = require("../../../client/core/deps/hammerhead");
// @ts-ignore
const domUtils = __importStar(require("../../../client/core/utils/dom"));
class ElementState {
    constructor({ element = null, clientPoint = null, screenPoint = null, isTarget = false, inMoving = false, devicePoint = null }) {
        this.element = element;
        this.clientPoint = clientPoint;
        this.screenPoint = screenPoint;
        this.devicePoint = devicePoint;
        this.isTarget = isTarget;
        this.inMoving = inMoving;
    }
    static async create({ element, clientPoint, screenPoint, isTarget, inMoving }) {
        let devicePoint = null;
        if (clientPoint)
            devicePoint = await get_device_point_1.default(clientPoint);
        const state = new ElementState({ element, clientPoint, screenPoint, isTarget, inMoving, devicePoint });
        return state;
    }
}
class VisibleElementAutomation extends event_emitter_1.default {
    constructor(element, offsetOptions, win, cursor) {
        super();
        this.TARGET_ELEMENT_FOUND_EVENT = 'automation|target-element-found-event';
        this.element = element;
        this.options = offsetOptions;
        this.automationSettings = new settings_1.default(offsetOptions.speed || 1);
        this.window = win;
        this.cursor = cursor;
        // NOTE: only for legacy API
        adapter_1.adapter.automations._ensureWindowAndCursorForLegacyTests(this);
    }
    async _getElementForEvent(eventArgs) {
        const expectedElement = await adapter_1.adapter.position.containsOffset(this.element, this.options.offsetX, this.options.offsetY) ? this.element : null;
        return get_element_1.default(eventArgs.point, this.window, expectedElement);
    }
    async _moveToElement() {
        const moveOptions = new options_1.MoveOptions(hammerhead_1.utils.extend({ skipScrolling: true }, this.options), false);
        const moveAutomation = await move_1.default.create(this.element, moveOptions, this.window, this.cursor);
        return moveAutomation
            .run()
            .then(() => delay_1.default(this.automationSettings.mouseActionStepDelay));
    }
    _scrollToElement() {
        let wasScrolled = false;
        const scrollOptions = new options_1.ScrollOptions(this.options, false);
        return adapter_1.adapter.scroll(this.element, scrollOptions)
            .then(scrollWasPerformed => {
            wasScrolled = scrollWasPerformed;
            return delay_1.default(this.automationSettings.mouseActionStepDelay);
        })
            .then(() => get_element_1.default(this.cursor.getPosition(), this.window))
            .then(currentElement => {
            return adapter_1.adapter.ensureMouseEventAfterScroll(currentElement, this.element, wasScrolled);
        })
            .then(() => {
            return wasScrolled;
        });
    }
    async _getElementOffset() {
        const defaultOffsets = await offsets_1.getOffsetOptions(this.element);
        let { offsetX, offsetY } = this.options;
        offsetX = offsetX || offsetX === 0 ? offsetX : defaultOffsets.offsetX;
        offsetY = offsetY || offsetY === 0 ? offsetY : defaultOffsets.offsetY;
        return { offsetX, offsetY };
    }
    async _wrapAction(action) {
        const { offsetX: x, offsetY: y } = await this._getElementOffset();
        const screenPointBeforeAction = await get_automation_point_1.default(this.element, { x, y });
        const clientPositionBeforeAction = await adapter_1.adapter.position.getClientPosition(this.element);
        await action();
        const screenPointAfterAction = await get_automation_point_1.default(this.element, { x, y });
        const clientPositionAfterAction = await adapter_1.adapter.position.getClientPosition(this.element);
        const clientPoint = await screen_point_to_client_1.default(this.element, screenPointAfterAction);
        const expectedElement = await adapter_1.adapter.position.containsOffset(this.element, x, y) ? this.element : null;
        const element = await get_element_1.default(clientPoint, this.window, expectedElement);
        if (!element) {
            return ElementState.create({
                element: null,
                clientPoint: null,
                screenPoint: null,
                isTarget: false,
                inMoving: false,
            });
        }
        let isTarget = !expectedElement || element === expectedElement || element === this.element;
        if (!isTarget) {
            // NOTE: perform an operation with searching in dom only if necessary
            isTarget = await this._contains(this.element, element);
        }
        const offsetPositionChanged = screenPointBeforeAction.x !== screenPointAfterAction.x ||
            screenPointBeforeAction.y !== screenPointAfterAction.y;
        const clientPositionChanged = clientPositionBeforeAction.x !== clientPositionAfterAction.x ||
            clientPositionBeforeAction.y !== clientPositionAfterAction.y;
        // NOTE: We consider the element moved if its offset position and client position
        // are changed both. If only client position was changed it means the page was
        // scrolled and the element keeps its position on the page. If only offset position was
        // changed it means the element is fixed on the page (it can be implemented via script).
        const targetElementIsMoving = offsetPositionChanged && clientPositionChanged;
        return ElementState.create({
            element,
            clientPoint,
            screenPoint: screenPointAfterAction,
            isTarget,
            inMoving: targetElementIsMoving,
        });
    }
    static _checkElementState(state, useStrictElementCheck) {
        if (!state.element)
            throw new Error(automation_errors_1.default.elementIsInvisibleError);
        if (useStrictElementCheck && (!state.isTarget || state.inMoving))
            throw new Error(automation_errors_1.default.foundElementIsNotTarget);
        return state;
    }
    _ensureElement(useStrictElementCheck, skipCheckAfterMoving = false, skipMoving = false) {
        return this
            ._wrapAction(() => this._scrollToElement())
            .then(state => VisibleElementAutomation._checkElementState(state, useStrictElementCheck))
            .then(state => {
            return skipMoving ? state : this._wrapAction(() => this._moveToElement());
        })
            .then(state => {
            if (!skipCheckAfterMoving)
                VisibleElementAutomation._checkElementState(state, useStrictElementCheck);
            return state;
        })
            .then(state => {
            this.emit(this.TARGET_ELEMENT_FOUND_EVENT, { element: (state === null || state === void 0 ? void 0 : state.element) || null });
            return {
                element: (state === null || state === void 0 ? void 0 : state.element) || null,
                clientPoint: (state === null || state === void 0 ? void 0 : state.clientPoint) || null,
                screenPoint: (state === null || state === void 0 ? void 0 : state.screenPoint) || null,
                devicePoint: (state === null || state === void 0 ? void 0 : state.devicePoint) || null,
            };
        });
    }
    async _contains(parent, child) {
        const parents = await domUtils.getParents(child);
        for (const el of parents) {
            if (el === parent)
                return true;
        }
        return false;
    }
}
exports.default = VisibleElementAutomation;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaWJsZS1lbGVtZW50LWF1dG9tYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc2hhcmVkL2FjdGlvbnMvYXV0b21hdGlvbnMvdmlzaWJsZS1lbGVtZW50LWF1dG9tYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXdDO0FBQ3hDLHlGQUErRDtBQUMvRCw2RkFBa0U7QUFDbEUsaUZBQXVEO0FBQ3ZELDhDQUFvRDtBQUNwRCxzRkFBc0U7QUFDdEUsaUdBQThFO0FBQzlFLDRGQUE4RTtBQUM5RSxrREFBb0M7QUFJcEMsOERBQXNDO0FBQ3RDLHdGQUFxRTtBQUVyRSxnRUFJNEM7QUFFNUMsYUFBYTtBQUNiLHFFQUE2RDtBQUM3RCxhQUFhO0FBQ2IseUVBQTJEO0FBYzNELE1BQU0sWUFBWTtJQVFkLFlBQXVCLEVBQUUsT0FBTyxHQUFHLElBQUksRUFBRSxXQUFXLEdBQUcsSUFBSSxFQUFFLFdBQVcsR0FBRyxJQUFJLEVBQUUsUUFBUSxHQUFHLEtBQUssRUFBRSxRQUFRLEdBQUcsS0FBSyxFQUFFLFdBQVcsR0FBRyxJQUFJLEVBQXVCO1FBQzFKLElBQUksQ0FBQyxPQUFPLEdBQU8sT0FBTyxDQUFDO1FBQzNCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQy9CLElBQUksQ0FBQyxRQUFRLEdBQU0sUUFBUSxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLEdBQU0sUUFBUSxDQUFDO0lBQ2hDLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBSyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQXVCO1FBQ3pHLElBQUksV0FBVyxHQUFHLElBQUks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T0FBTyxHQUFHLE1BQU0sUUFBUSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVqRCxLQUFLLE1BQU0sRUFBRSxJQUFJLE9BQU8sRUFBRTtZQUN0QixJQUFJLEVBQUUsS0FBSyxNQUFNO2dCQUNiLE9BQU8sSUFBSSxDQUFDO1NBQ25CO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBcktELDJDQXFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkYXB0ZXIgfSBmcm9tICcuLi8uLi9hZGFwdGVyJztcbmltcG9ydCBnZXRBdXRvbWF0aW9uUG9pbnQgZnJvbSAnLi4vdXRpbHMvZ2V0LWF1dG9tYXRpb24tcG9pbnQnO1xuaW1wb3J0IHNjcmVlblBvaW50VG9DbGllbnQgZnJvbSAnLi4vdXRpbHMvc2NyZWVuLXBvaW50LXRvLWNsaWVudCc7XG5pbXBvcnQgZ2V0RGV2aWNlUG9pbnQgZnJvbSAnLi4vdXRpbHMvZ2V0LWRldmljZS1wb2ludCc7XG5pbXBvcnQgeyBnZXRPZmZzZXRPcHRpb25zIH0gZnJvbSAnLi4vdXRpbHMvb2Zmc2V0cyc7XG5pbXBvcnQgZ2V0RWxlbWVudEZyb21Qb2ludCBmcm9tICcuLi8uLi8uLi9zaGFyZWQvYWN0aW9ucy9nZXQtZWxlbWVudCc7XG5pbXBvcnQgQVVUT01BVElPTl9FUlJPUl9UWVBFUyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvZXJyb3JzL2F1dG9tYXRpb24tZXJyb3JzJztcbmltcG9ydCBBdXRvbWF0aW9uU2V0dGluZ3MgZnJvbSAnLi4vLi4vLi4vc2hhcmVkL2FjdGlvbnMvYXV0b21hdGlvbnMvc2V0dGluZ3MnO1xuaW1wb3J0IE1vdmVBdXRvbWF0aW9uIGZyb20gJy4vbW92ZSc7XG5pbXBvcnQgeyBTaGFyZWRXaW5kb3cgfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgQXhpc1ZhbHVlcywgeyBBeGlzVmFsdWVzRGF0YSB9IGZyb20gJy4uLy4uL3V0aWxzL3ZhbHVlcy9heGlzLXZhbHVlcyc7XG5pbXBvcnQgQ3Vyc29yIGZyb20gJy4uL2N1cnNvcic7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IFNoYXJlZEV2ZW50RW1pdHRlciBmcm9tICcuLi8uLi8uLi9zaGFyZWQvdXRpbHMvZXZlbnQtZW1pdHRlcic7XG5cbmltcG9ydCB7XG4gICAgTW92ZU9wdGlvbnMsXG4gICAgU2Nyb2xsT3B0aW9ucyxcbiAgICBPZmZzZXRPcHRpb25zLFxufSBmcm9tICcuLi8uLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vcHRpb25zJztcblxuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi8uLi8uLi9jbGllbnQvY29yZS9kZXBzL2hhbW1lcmhlYWQnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0ICogYXMgZG9tVXRpbHMgZnJvbSAnLi4vLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvZG9tJztcblxuaW50ZXJmYWNlIEVsZW1lbnRTdGF0ZUFyZ3NCYXNlPEU+IHtcbiAgICBlbGVtZW50OiBFIHwgbnVsbDtcbiAgICBjbGllbnRQb2ludDogQXhpc1ZhbHVlczxudW1iZXI+IHwgbnVsbDtcbiAgICBzY3JlZW5Qb2ludDogQXhpc1ZhbHVlczxudW1iZXI+IHwgbnVsbDtcbiAgICBkZXZpY2VQb2ludD86IEF4aXNWYWx1ZXM8bnVtYmVyPiB8IG51bGw7XG59XG5cbmludGVyZmFjZSBFbGVtZW50U3RhdGVBcmdzPEU+IGV4dGVuZHMgRWxlbWVudFN0YXRlQXJnc0Jhc2U8RT4ge1xuICAgIGlzVGFyZ2V0OiBib29sZWFuO1xuICAgIGluTW92aW5nOiBib29sZWFuO1xufVxuXG5jbGFzcyBFbGVtZW50U3RhdGU8RT4gaW1wbGVtZW50cyBFbGVtZW50U3RhdGVBcmdzPEU+IHtcbiAgICBwdWJsaWMgZWxlbWVudDogRSB8IG51bGw7XG4gICAgcHVibGljIGNsaWVudFBvaW50OiBBeGlzVmFsdWVzPG51bWJlcj4gfCBudWxsO1xuICAgIHB1YmxpYyBzY3JlZW5Qb2ludDogQXhpc1ZhbHVlczxudW1iZXI+IHwgbnVsbDtcbiAgICBwdWJsaWMgZGV2aWNlUG9pbnQ6IEF4aXNWYWx1ZXM8bnVtYmVyPiB8IG51bGw7XG4gICAgcHVibGljIGlzVGFyZ2V0OiBib29sZWFuO1xuICAgIHB1YmxpYyBpbk1vdmluZzogYm9vbGVhbjtcblxuICAgIHByb3RlY3RlZCBjb25zdHJ1Y3RvciAoeyBlbGVtZW50ID0gbnVsbCwgY2xpZW50UG9pbnQgPSBudWxsLCBzY3JlZW5Qb2ludCA9IG51bGwsIGlzVGFyZ2V0ID0gZmFsc2UsIGluTW92aW5nID0gZmFsc2UsIGRldmljZVBvaW50ID0gbnVsbCB9OiBFbGVtZW50U3RhdGVBcmdzPEU+KSB7XG4gICAgICAgIHRoaXMuZWxlbWVudCAgICAgPSBlbGVtZW50O1xuICAgICAgICB0aGlzLmNsaWVudFBvaW50ID0gY2xpZW50UG9pbnQ7XG4gICAgICAgIHRoaXMuc2NyZWVuUG9pbnQgPSBzY3JlZW5Qb2ludDtcbiAgICAgICAgdGhpcy5kZXZpY2VQb2ludCA9IGRldmljZVBvaW50O1xuICAgICAgICB0aGlzLmlzVGFyZ2V0ICAgID0gaXNUYXJnZXQ7XG4gICAgICAgIHRoaXMuaW5Nb3ZpbmcgICAgPSBpbk1vdmluZztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZTxFPiAoeyBlbGVtZW50LCBjbGllbnRQb2ludCwgc2NyZWVuUG9pbnQsIGlzVGFyZ2V0LCBpbk1vdmluZyB9OiBFbGVtZW50U3RhdGVBcmdzPEU+KTogUHJvbWlzZTxFbGVtZW50U3RhdGU8RT4+IHtcbiAgICAgICAgbGV0IGRldmljZVBvaW50ID0gbnVsbDtcblxuICAgICAgICBpZiAoY2xpZW50UG9pbnQpXG4gICAgICAgICAgICBkZXZpY2VQb2ludCA9IGF3YWl0IGdldERldmljZVBvaW50KGNsaWVudFBvaW50KTtcblxuICAgICAgICBjb25zdCBzdGF0ZSA9IG5ldyBFbGVtZW50U3RhdGU8RT4oeyBlbGVtZW50LCBjbGllbnRQb2ludCwgc2NyZWVuUG9pbnQsIGlzVGFyZ2V0LCBpbk1vdmluZywgZGV2aWNlUG9pbnQgfSk7XG5cbiAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBNb3VzZUV2ZW50QXJnczxFPiB7XG4gICAgcG9pbnQ6IEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4gfCBudWxsO1xuICAgIHNjcmVlblBvaW50OiBBeGlzVmFsdWVzRGF0YTxudW1iZXI+IHwgbnVsbDtcbiAgICBlbGVtZW50OiBFIHwgbnVsbDtcbiAgICBvcHRpb25zOiB7XG4gICAgICAgIGNsaWVudFg6IG51bWJlcjtcbiAgICAgICAgY2xpZW50WTogbnVtYmVyO1xuICAgICAgICBzY3JlZW5YOiBudW1iZXI7XG4gICAgICAgIHNjcmVlblk6IG51bWJlcjtcbiAgICAgICAgY3RybDogYm9vbGVhbjtcbiAgICAgICAgYWx0OiBib29sZWFuO1xuICAgICAgICBzaGlmdDogYm9vbGVhbjtcbiAgICAgICAgbWV0YTogYm9vbGVhbjtcbiAgICAgICAgdGltZVN0YW1wOiB1bmtub3duO1xuICAgIH0gfCBudWxsO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWaXNpYmxlRWxlbWVudEF1dG9tYXRpb248RSwgVyBleHRlbmRzIFNoYXJlZFdpbmRvdz4gZXh0ZW5kcyBTaGFyZWRFdmVudEVtaXR0ZXIge1xuICAgIHByb3RlY3RlZCBlbGVtZW50OiBFO1xuICAgIHByaXZhdGUgd2luZG93OiBXO1xuICAgIHByb3RlY3RlZCBjdXJzb3I6IEN1cnNvcjxXPlxuICAgIHByaXZhdGUgVEFSR0VUX0VMRU1FTlRfRk9VTkRfRVZFTlQ6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgYXV0b21hdGlvblNldHRpbmdzOiBBdXRvbWF0aW9uU2V0dGluZ3M7XG4gICAgcHJpdmF0ZSBvcHRpb25zOiBPZmZzZXRPcHRpb25zO1xuXG4gICAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yIChlbGVtZW50OiBFLCBvZmZzZXRPcHRpb25zOiBPZmZzZXRPcHRpb25zLCB3aW46IFcsIGN1cnNvcjogQ3Vyc29yPFc+KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5UQVJHRVRfRUxFTUVOVF9GT1VORF9FVkVOVCA9ICdhdXRvbWF0aW9ufHRhcmdldC1lbGVtZW50LWZvdW5kLWV2ZW50JztcblxuICAgICAgICB0aGlzLmVsZW1lbnQgICAgICAgICAgICA9IGVsZW1lbnQ7XG4gICAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICAgID0gb2Zmc2V0T3B0aW9ucztcbiAgICAgICAgdGhpcy5hdXRvbWF0aW9uU2V0dGluZ3MgPSBuZXcgQXV0b21hdGlvblNldHRpbmdzKG9mZnNldE9wdGlvbnMuc3BlZWQgfHwgMSk7XG5cbiAgICAgICAgdGhpcy53aW5kb3cgID0gd2luO1xuICAgICAgICB0aGlzLmN1cnNvciAgPSBjdXJzb3I7XG5cbiAgICAgICAgLy8gTk9URTogb25seSBmb3IgbGVnYWN5IEFQSVxuICAgICAgICBhZGFwdGVyLmF1dG9tYXRpb25zLl9lbnN1cmVXaW5kb3dBbmRDdXJzb3JGb3JMZWdhY3lUZXN0cyh0aGlzKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgX2dldEVsZW1lbnRGb3JFdmVudCAoZXZlbnRBcmdzOiBNb3VzZUV2ZW50QXJnczxFPik6IFByb21pc2U8RSB8IG51bGw+IHtcbiAgICAgICAgY29uc3QgZXhwZWN0ZWRFbGVtZW50ID0gYXdhaXQgYWRhcHRlci5wb3NpdGlvbi5jb250YWluc09mZnNldCh0aGlzLmVsZW1lbnQsIHRoaXMub3B0aW9ucy5vZmZzZXRYLCB0aGlzLm9wdGlvbnMub2Zmc2V0WSkgPyB0aGlzLmVsZW1lbnQgOiBudWxsO1xuXG4gICAgICAgIHJldHVybiBnZXRFbGVtZW50RnJvbVBvaW50KGV2ZW50QXJncy5wb2ludCBhcyBBeGlzVmFsdWVzRGF0YTxudW1iZXI+LCB0aGlzLndpbmRvdywgZXhwZWN0ZWRFbGVtZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9tb3ZlVG9FbGVtZW50ICgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgbW92ZU9wdGlvbnMgICAgPSBuZXcgTW92ZU9wdGlvbnModXRpbHMuZXh0ZW5kKHsgc2tpcFNjcm9sbGluZzogdHJ1ZSB9LCB0aGlzLm9wdGlvbnMpLCBmYWxzZSk7XG4gICAgICAgIGNvbnN0IG1vdmVBdXRvbWF0aW9uID0gYXdhaXQgTW92ZUF1dG9tYXRpb24uY3JlYXRlKHRoaXMuZWxlbWVudCwgbW92ZU9wdGlvbnMsIHRoaXMud2luZG93LCB0aGlzLmN1cnNvcik7XG5cbiAgICAgICAgcmV0dXJuIG1vdmVBdXRvbWF0aW9uXG4gICAgICAgICAgICAucnVuKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGRlbGF5KHRoaXMuYXV0b21hdGlvblNldHRpbmdzLm1vdXNlQWN0aW9uU3RlcERlbGF5KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2Nyb2xsVG9FbGVtZW50ICgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgbGV0IHdhc1Njcm9sbGVkICAgICAgICA9IGZhbHNlO1xuICAgICAgICBjb25zdCBzY3JvbGxPcHRpb25zICAgID0gbmV3IFNjcm9sbE9wdGlvbnModGhpcy5vcHRpb25zLCBmYWxzZSk7XG5cbiAgICAgICAgcmV0dXJuIGFkYXB0ZXIuc2Nyb2xsKHRoaXMuZWxlbWVudCwgc2Nyb2xsT3B0aW9ucylcbiAgICAgICAgICAgIC50aGVuKHNjcm9sbFdhc1BlcmZvcm1lZCA9PiB7XG4gICAgICAgICAgICAgICAgd2FzU2Nyb2xsZWQgPSBzY3JvbGxXYXNQZXJmb3JtZWQ7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZGVsYXkodGhpcy5hdXRvbWF0aW9uU2V0dGluZ3MubW91c2VBY3Rpb25TdGVwRGVsYXkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGdldEVsZW1lbnRGcm9tUG9pbnQodGhpcy5jdXJzb3IuZ2V0UG9zaXRpb24oKSwgdGhpcy53aW5kb3cpKVxuICAgICAgICAgICAgLnRoZW4oY3VycmVudEVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBhZGFwdGVyLmVuc3VyZU1vdXNlRXZlbnRBZnRlclNjcm9sbChjdXJyZW50RWxlbWVudCwgdGhpcy5lbGVtZW50LCB3YXNTY3JvbGxlZCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB3YXNTY3JvbGxlZDtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2dldEVsZW1lbnRPZmZzZXQgKCk6IFByb21pc2U8eyBvZmZzZXRYOiBudW1iZXI7IG9mZnNldFk6IG51bWJlciB9PiB7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRPZmZzZXRzID0gYXdhaXQgZ2V0T2Zmc2V0T3B0aW9ucyh0aGlzLmVsZW1lbnQpO1xuXG4gICAgICAgIGxldCB7IG9mZnNldFgsIG9mZnNldFkgfSA9IHRoaXMub3B0aW9ucztcblxuICAgICAgICBvZmZzZXRYID0gb2Zmc2V0WCB8fCBvZmZzZXRYID09PSAwID8gb2Zmc2V0WCA6IGRlZmF1bHRPZmZzZXRzLm9mZnNldFg7XG4gICAgICAgIG9mZnNldFkgPSBvZmZzZXRZIHx8IG9mZnNldFkgPT09IDAgPyBvZmZzZXRZIDogZGVmYXVsdE9mZnNldHMub2Zmc2V0WTtcblxuICAgICAgICByZXR1cm4geyBvZmZzZXRYLCBvZmZzZXRZIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfd3JhcEFjdGlvbiAoYWN0aW9uOiAoKSA9PiBQcm9taXNlPHVua25vd24+KTogUHJvbWlzZTxFbGVtZW50U3RhdGU8RT4+IHtcbiAgICAgICAgY29uc3QgeyBvZmZzZXRYOiB4LCBvZmZzZXRZOiB5IH0gPSBhd2FpdCB0aGlzLl9nZXRFbGVtZW50T2Zmc2V0KCk7XG4gICAgICAgIGNvbnN0IHNjcmVlblBvaW50QmVmb3JlQWN0aW9uICAgID0gYXdhaXQgZ2V0QXV0b21hdGlvblBvaW50KHRoaXMuZWxlbWVudCwgeyB4LCB5IH0pO1xuICAgICAgICBjb25zdCBjbGllbnRQb3NpdGlvbkJlZm9yZUFjdGlvbiA9IGF3YWl0IGFkYXB0ZXIucG9zaXRpb24uZ2V0Q2xpZW50UG9zaXRpb24odGhpcy5lbGVtZW50KTtcblxuICAgICAgICBhd2FpdCBhY3Rpb24oKTtcblxuICAgICAgICBjb25zdCBzY3JlZW5Qb2ludEFmdGVyQWN0aW9uICAgID0gYXdhaXQgZ2V0QXV0b21hdGlvblBvaW50KHRoaXMuZWxlbWVudCwgeyB4LCB5IH0pO1xuICAgICAgICBjb25zdCBjbGllbnRQb3NpdGlvbkFmdGVyQWN0aW9uID0gYXdhaXQgYWRhcHRlci5wb3NpdGlvbi5nZXRDbGllbnRQb3NpdGlvbih0aGlzLmVsZW1lbnQpO1xuICAgICAgICBjb25zdCBjbGllbnRQb2ludCAgICAgICAgICAgICAgID0gYXdhaXQgc2NyZWVuUG9pbnRUb0NsaWVudCh0aGlzLmVsZW1lbnQsIHNjcmVlblBvaW50QWZ0ZXJBY3Rpb24pO1xuICAgICAgICBjb25zdCBleHBlY3RlZEVsZW1lbnQgICAgICAgICAgID0gYXdhaXQgYWRhcHRlci5wb3NpdGlvbi5jb250YWluc09mZnNldCh0aGlzLmVsZW1lbnQsIHgsIHkpID8gdGhpcy5lbGVtZW50IDogbnVsbDtcblxuICAgICAgICBjb25zdCBlbGVtZW50ID0gYXdhaXQgZ2V0RWxlbWVudEZyb21Qb2ludChjbGllbnRQb2ludCwgdGhpcy53aW5kb3csIGV4cGVjdGVkRWxlbWVudCk7XG5cbiAgICAgICAgaWYgKCFlbGVtZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gRWxlbWVudFN0YXRlLmNyZWF0ZTxFPih7XG4gICAgICAgICAgICAgICAgZWxlbWVudDogICAgIG51bGwsXG4gICAgICAgICAgICAgICAgY2xpZW50UG9pbnQ6IG51bGwsXG4gICAgICAgICAgICAgICAgc2NyZWVuUG9pbnQ6IG51bGwsXG4gICAgICAgICAgICAgICAgaXNUYXJnZXQ6ICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIGluTW92aW5nOiAgICBmYWxzZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGlzVGFyZ2V0ID0gIWV4cGVjdGVkRWxlbWVudCB8fCBlbGVtZW50ID09PSBleHBlY3RlZEVsZW1lbnQgfHwgZWxlbWVudCA9PT0gdGhpcy5lbGVtZW50O1xuXG4gICAgICAgIGlmICghaXNUYXJnZXQpIHtcbiAgICAgICAgICAgIC8vIE5PVEU6IHBlcmZvcm0gYW4gb3BlcmF0aW9uIHdpdGggc2VhcmNoaW5nIGluIGRvbSBvbmx5IGlmIG5lY2Vzc2FyeVxuICAgICAgICAgICAgaXNUYXJnZXQgPSBhd2FpdCB0aGlzLl9jb250YWlucyh0aGlzLmVsZW1lbnQsIGVsZW1lbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb2Zmc2V0UG9zaXRpb25DaGFuZ2VkID0gc2NyZWVuUG9pbnRCZWZvcmVBY3Rpb24ueCAhPT0gc2NyZWVuUG9pbnRBZnRlckFjdGlvbi54IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5Qb2ludEJlZm9yZUFjdGlvbi55ICE9PSBzY3JlZW5Qb2ludEFmdGVyQWN0aW9uLnk7XG4gICAgICAgIGNvbnN0IGNsaWVudFBvc2l0aW9uQ2hhbmdlZCA9IGNsaWVudFBvc2l0aW9uQmVmb3JlQWN0aW9uLnggIT09IGNsaWVudFBvc2l0aW9uQWZ0ZXJBY3Rpb24ueCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpZW50UG9zaXRpb25CZWZvcmVBY3Rpb24ueSAhPT0gY2xpZW50UG9zaXRpb25BZnRlckFjdGlvbi55O1xuXG4gICAgICAgIC8vIE5PVEU6IFdlIGNvbnNpZGVyIHRoZSBlbGVtZW50IG1vdmVkIGlmIGl0cyBvZmZzZXQgcG9zaXRpb24gYW5kIGNsaWVudCBwb3NpdGlvblxuICAgICAgICAvLyBhcmUgY2hhbmdlZCBib3RoLiBJZiBvbmx5IGNsaWVudCBwb3NpdGlvbiB3YXMgY2hhbmdlZCBpdCBtZWFucyB0aGUgcGFnZSB3YXNcbiAgICAgICAgLy8gc2Nyb2xsZWQgYW5kIHRoZSBlbGVtZW50IGtlZXBzIGl0cyBwb3NpdGlvbiBvbiB0aGUgcGFnZS4gSWYgb25seSBvZmZzZXQgcG9zaXRpb24gd2FzXG4gICAgICAgIC8vIGNoYW5nZWQgaXQgbWVhbnMgdGhlIGVsZW1lbnQgaXMgZml4ZWQgb24gdGhlIHBhZ2UgKGl0IGNhbiBiZSBpbXBsZW1lbnRlZCB2aWEgc2NyaXB0KS5cbiAgICAgICAgY29uc3QgdGFyZ2V0RWxlbWVudElzTW92aW5nID0gb2Zmc2V0UG9zaXRpb25DaGFuZ2VkICYmIGNsaWVudFBvc2l0aW9uQ2hhbmdlZDtcblxuICAgICAgICByZXR1cm4gRWxlbWVudFN0YXRlLmNyZWF0ZSh7XG4gICAgICAgICAgICBlbGVtZW50LFxuICAgICAgICAgICAgY2xpZW50UG9pbnQsXG4gICAgICAgICAgICBzY3JlZW5Qb2ludDogc2NyZWVuUG9pbnRBZnRlckFjdGlvbixcbiAgICAgICAgICAgIGlzVGFyZ2V0LFxuICAgICAgICAgICAgaW5Nb3Zpbmc6ICAgIHRhcmdldEVsZW1lbnRJc01vdmluZyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2NoZWNrRWxlbWVudFN0YXRlPEU+IChzdGF0ZTogRWxlbWVudFN0YXRlPEU+LCB1c2VTdHJpY3RFbGVtZW50Q2hlY2s6IGJvb2xlYW4pOiBFbGVtZW50U3RhdGU8RT4ge1xuICAgICAgICBpZiAoIXN0YXRlLmVsZW1lbnQpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQVVUT01BVElPTl9FUlJPUl9UWVBFUy5lbGVtZW50SXNJbnZpc2libGVFcnJvcik7XG5cbiAgICAgICAgaWYgKHVzZVN0cmljdEVsZW1lbnRDaGVjayAmJiAoIXN0YXRlLmlzVGFyZ2V0IHx8IHN0YXRlLmluTW92aW5nKSlcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihBVVRPTUFUSU9OX0VSUk9SX1RZUEVTLmZvdW5kRWxlbWVudElzTm90VGFyZ2V0KTtcblxuICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIF9lbnN1cmVFbGVtZW50ICh1c2VTdHJpY3RFbGVtZW50Q2hlY2s6IGJvb2xlYW4sIHNraXBDaGVja0FmdGVyTW92aW5nID0gZmFsc2UsIHNraXBNb3ZpbmcgPSBmYWxzZSk6IFByb21pc2U8RWxlbWVudFN0YXRlQXJnc0Jhc2U8RT4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgIC5fd3JhcEFjdGlvbigoKSA9PiB0aGlzLl9zY3JvbGxUb0VsZW1lbnQoKSlcbiAgICAgICAgICAgIC50aGVuKHN0YXRlID0+IFZpc2libGVFbGVtZW50QXV0b21hdGlvbi5fY2hlY2tFbGVtZW50U3RhdGUoc3RhdGUsIHVzZVN0cmljdEVsZW1lbnRDaGVjaykpXG4gICAgICAgICAgICAudGhlbihzdGF0ZSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNraXBNb3ZpbmcgPyBzdGF0ZSA6IHRoaXMuX3dyYXBBY3Rpb24oKCkgPT4gdGhpcy5fbW92ZVRvRWxlbWVudCgpKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihzdGF0ZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFza2lwQ2hlY2tBZnRlck1vdmluZylcbiAgICAgICAgICAgICAgICAgICAgVmlzaWJsZUVsZW1lbnRBdXRvbWF0aW9uLl9jaGVja0VsZW1lbnRTdGF0ZShzdGF0ZSwgdXNlU3RyaWN0RWxlbWVudENoZWNrKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihzdGF0ZSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KHRoaXMuVEFSR0VUX0VMRU1FTlRfRk9VTkRfRVZFTlQsIHsgZWxlbWVudDogc3RhdGU/LmVsZW1lbnQgfHwgbnVsbCB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6ICAgICBzdGF0ZT8uZWxlbWVudCB8fCBudWxsLFxuICAgICAgICAgICAgICAgICAgICBjbGllbnRQb2ludDogc3RhdGU/LmNsaWVudFBvaW50IHx8IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHNjcmVlblBvaW50OiBzdGF0ZT8uc2NyZWVuUG9pbnQgfHwgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZGV2aWNlUG9pbnQ6IHN0YXRlPy5kZXZpY2VQb2ludCB8fCBudWxsLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9jb250YWlucyAocGFyZW50OiBFLCBjaGlsZDogRSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBwYXJlbnRzID0gYXdhaXQgZG9tVXRpbHMuZ2V0UGFyZW50cyhjaGlsZCk7XG5cbiAgICAgICAgZm9yIChjb25zdCBlbCBvZiBwYXJlbnRzKSB7XG4gICAgICAgICAgICBpZiAoZWwgPT09IHBhcmVudClcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG4iXX0=